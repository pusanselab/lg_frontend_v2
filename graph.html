<!DOCTYPE html>
<html>
    <header>
        <title>LG Air Data Virtualization</title>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
       
        <link rel="stylesheet" href="css/bootstrap.css">
    </header>
    <body>
        <div id="sub">
            <h1> ■ 그래프 추가</h1>


        </div>
        <div id="graph_table" class="table-responsive">
                <table id="detail_table" class="table table-striped table-bordered table-hover table-condensed">
                <tbody id="detail_body">
                    <thead>
                    <tr>
                    <td>name</td>
                    <td>unit</td>
                    <td>section</td>
                    <td>sector</td>
                    <td>그래프 선택</td>
                </thead>
                </tr>
            </tbody>
            </table>

            <button class='button' onclick='showGraph()'>그래프 보기</button>

        </div>
        <div id="graph">
            <div id="Line_Controls_Chart">
                <!-- 라인 차트 생성할 영역 -->
                    <div id="lineChartArea" style="padding:0px 20px 0px 0px;"></div>
                <!-- 컨트롤바를 생성할 영역 -->
                    <div id="controlsArea" style="padding:0px 20px 0px 0px;"></div>
              </div>
            <div id="selectgraph1">
                <form id="selectgraph">

                </form>
            </div>
        </div>
        <span></span>
    </body>



    <!--Script-->

    <script src="assets/js/jquery.min.js"></script>
    <script src="assets/js/jquery.scrolly.min.js"></script>
    <script src="assets/js/jquery.dropotron.min.js"></script>
    <script src="assets/js/jquery.scrollex.min.js"></script>
    <script src="assets/js/browser.min.js"></script>
    <script src="assets/js/breakpoints.min.js"></script>
    <script src="assets/js/util.js"></script>
    <script src="assets/js/main.js"></script>
    <script src="http://code.jquery.com/ui/1.11.2/jquery-ui.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script> 
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script src="https://d3js.org/d3-array.v2.min.js"></script>
    <script src="https://d3js.org/d3-color.v1.min.js"></script>
    <script src="https://d3js.org/d3-format.v1.min.js"></script>
    <script src="https://d3js.org/d3-interpolate.v1.min.js"></script>
    <script src="https://d3js.org/d3-time.v1.min.js"></script>
    <script src="https://d3js.org/d3-time-format.v2.min.js"></script>
    <script src="https://d3js.org/d3-scale.v3.min.js"></script>
    <script data-require="d3@4.0.0" data-semver="4.0.0" src="https://d3js.org/d3.v4.min.js"></script>

    <link href="http://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css" rel="stylesheet">   
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
    <link rel="stylesheet" href="http://cdn.datatables.net/1.10.2/css/jquery.dataTables.min.css"></style>
    <script type="text/javascript" src="http://cdn.datatables.net/1.10.2/js/jquery.dataTables.min.js"></script>
    <script type="text/javascript" src="http://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>
    
    <script>


            var array;
            var index=0;
            var indexName=['Date'];
            var colName=[];
            var rowcount;
            var val;
                

            $(document).ready(function(){
                val = location.href.substr(
                location.href.lastIndexOf('=') + 1);
				console.log("enter login");
                var params="header_uid="+val;
				$.ajax({
					type: 'post'
					, url: 'http://localhost:3000/api/graph/items'
					, data: params
					, beforeSend: function() {
						$('#ajax_load_indicator').show().fadeIn('fast'); 
					}
					, success: function(data) {

                        for(var i=0;i<data.length;i++){
                            var header_uid = data[i].header_uid;
                            var name = data[i].name;
                            var unit = data[i].unit;
                            var section = data[i].section;
                            var section_count = data[i].section_count;
                            var check = "<input type='checkbox' name=\'check'\ id=\""+data[i].item+"\" onclick=\"select_box(\'"+data[i].item+"\',\'"+name+"\')\" value=\"\">";

                            var row = "<tr>";
                                  //  row+="<td>"+header_uid+"</td>";
                                    row+="<td>"+name+"</td>";
                                    row+="<td>"+unit+"</td>";
                                    row+="<td>"+section+"</td>";
                                    row+="<td>"+section_count+"</td>";
                                    row+="<td>"+check+"</td>";
                                    row+="</tr>"

                                $('#detail_body').append(row);
                        }
                        $('#detail_table').dataTable();
							
						}
						, error: function(data, status, err) {
							console.log("error forward : "+data);
							alert('서버와의 통신이 실패했습니다.');
						}
						, complete: function() { 
							$('#ajax_load_indicator').fadeOut();
						}
					});
				});

           
                // function SelectUnit(){
                    
                //     var first=$("#unit").val()
                //     var second = $("#index").val()
                //     var table_row = $('#detail_body tr').length;

                //     if(table_row>5){
                //         alert("5개 까지 선택 가능합니다.");
                //     }
                //     else if($('#index').val()==undefined){
                //         alert("값이 존재하는 것만 가능합니다.");

                //     }
                //     else{
                //         var button = "<button class='button' onclick='removeUnit(this)'>삭제</button>";
                //         var row = "<tr>";
                //         row+="<td>"+first+"</td>";
                //         row+="<td>"+second+"</td>";
                //         row+="<td>"+button+"</td>";
                //         row+="</tr>"

                //         $('#detail_body').append(row);
                //     }
                // }

                // function removeUnit(obj){
                //     var remove = $(obj).parent().parent();
                //     console.log("zz");
                //     console.log(remove);
                //     remove.remove(); 
                // }

                function showGraph(){
                   var rowData = new Array();
                   var params="header_uid="+val
                                +"&item_list="+colName;
                    var jsonparams = JSON.stringify({'header_uid':val,'item_list':colName});
                    console.log(jsonparams);

                console.log("enter login");
                $.ajax({
                    type: 'post'
                    , url: 'http://localhost:3000/api/graph/raws'
                    , data: jsonparams
                    , dataType:'json'
                    , contentType:'application/json'
                    , beforeSend: function() {
                        $('#ajax_load_indicator').show().fadeIn('fast'); 
                    }
                    , success: function(data) {
                        rowcount = data.time.length;

                        array=new Array(rowcount+1);
                        for(var i =0 ;i<rowcount+1;i++){
                            array[i]=new Array();
                        }

                        if($("input:checkbox:checked").length >0){
                            console.log("이안");
                            //   $("input:checkbox:checked").prop('checked',false);
                            
                            // for(var j=1;j<indexName.length;j++){
                            //         for(var i=0;i<rowcount;i++){
                            //             array[i].splice(j,1);
                            //         }
                            // }
                            // console.log(array);
                            // index=1;
                            // indexName.splice(1);
                            // drawingZZ(array,indexName,rowcount);
                            var datazz = data.time;
                            var dataxx = data.raws;
                            console.log(dataxx[1]);
                            var real_value = $.extend(true,[],dataxx[1]);

                            $.each(dataxx[0],function(key,value){
                                                console.log(value);
                                    });
                            
                            

                                for(var i =0; i<datazz.length;i++){
                                            var index = 1;
                                            var timedate = datazz[i].Date+" "+datazz[i].time;
                                            array[i][0]=((new Date(timedate)));
                                            $.each(dataxx[i],function(key,value){
                                                array[i][index]=value*1;
                                                index=index+1;
                                            });
                                            
                                            
                                            }
                                    }
                                    console.log(array);
                                    drawingZZ(array,indexName,datazz.length);
                            
                    }
                    , error: function(data, status, err) {
                        console.log("error forward : "+data);
                        alert('서버와의 통신이 실패했습니다.');
                    }
                    , complete: function() { 
                        $('#ajax_load_indicator').fadeOut();
                    }
                });


        
                //    htmltest+="</div>";
                //    $('#selectgraph').html(htmltest);


                }


                function select_box(col,name){
                          
                    if($("input:checkbox:checked").length >8){
                        $('input[name='+col+']').prop('checked', false);
                        alert("최대 8개까지 가능합니다.");
                    }
                    else{
                        if(!($('input[id='+col+']').is(':checked'))){
                            var remove=indexName.indexOf(name);
                            var remove2=colName.indexOf(col);
                            
                            // for(var i=0;i<datazz.length;i++){
                            //     array[i].splice(remove,1);
                            // }
                            indexName.splice(remove,1);
                            colName.splice(remove2,1);
                            index-=1;
                            
                        }
                        else{

                        index+=1;     
                                                    
                        indexName.push(name);
                        colName.push(col);

                        console.log(colName);
                        
                        
                        // for(var i =0; i<datazz.length;i++){
                            
                        //     array[i][0]=((new Date(datazz[i].TXT_TIME)));
                        //     array[i][index]=(datazz[i].value);
                        //     }
                        }
                        // drawingZZ(array,indexName,rowcount);

                    }
        
                }
                function graph_odu(section,col){
                    console.log("enter login");
                    console.log($("input:checkbox[name=odubox]:checked").length);
                    var val = location.href.substr(
                    location.href.lastIndexOf('=') + 1);
                    var params="header_uid="+val
                                +"&section_count="+section
                                +"&column_name="+col;
                 

						$.ajax({
							type: 'post'
							, url: 'http://localhost:3000/api/graph_odu'
							, data: params
							, beforeSend: function() {
								$('#ajax_load_indicator').show().fadeIn('fast'); 
							}
							, success: function(data1) {
                                
                                var datazz = data1.content;
                                
								if($("input:checkbox:checked").length >8){
                                    $('input[id='+col+']').prop('checked', false);
                                    alert("최대 8개까지 가능합니다.");
                                }
                                else{
                                    if(!($('input[id='+col+']').is(':checked'))){
                                        var remove=indexName.indexOf(col);
                        
                                        for(var i=0;i<datazz.length;i++){
                                            array[i].splice(remove,1);
                                        }
                                        indexName.splice(remove,1);
                                        index-=1;
                                        
                                    }
                                    else{


                                    var dateRow=[];
                                    var valRow=[];
                                    index+=1;
                                    var zero=0;
                                    
                                    indexName.push(col);
                                    console.log(indexName);
                                    
                                    for(var i =0; i<datazz.length;i++){
                                        console.log(array[i]);
                                        array[i][0]=((new Date(datazz[i].TXT_TIME)));
                                        array[i][index]=(datazz[i].value);
                                        }
                                    }
                                    drawingZZ(array,indexName,datazz.length);
           
                                }
							}
							, error: function(data, status, err) {
								console.log("error forward : "+data);
								alert('서버와의 통신이 실패했습니다.');
							}
							, complete: function() { 
								$('#ajax_load_indicator').fadeOut();
							}
						});
                }
                function graph_hru(section,col){
                    console.log("enter login");
                    console.log($("input:checkbox[name=idubox]:checked").length);
                    var val = location.href.substr(
                    location.href.lastIndexOf('=') + 1);
                    var params="header_uid="+val
                                +"&section_count="+section
                                +"&column_name="+col;
                    console.log(params);

						$.ajax({
							type: 'post'
							, url: 'http://localhost:3000/api/graph_hru'
							, data: params
							, beforeSend: function() {
								$('#ajax_load_indicator').show().fadeIn('fast'); 
							}
							, success: function(data) {
                                console.log("일단 통신은 성공");
								if($("input:checkbox:checked").length >8){
                                    $('input[id='+col+']').prop('checked', false);
                                    alert("최대 8개까지 가능합니다.");
                                }
                                else{

                                }
							}
							, error: function(data, status, err) {
								console.log("error forward : "+data);
								alert('서버와의 통신이 실패했습니다.');
							}
							, complete: function() { 
								$('#ajax_load_indicator').fadeOut();
							}
						});
                }
                function graph_cal(section,col){
                    console.log("enter login");
                    console.log($("input:checkbox[name=idubox]:checked").length);
                    var val = location.href.substr(
                    location.href.lastIndexOf('=') + 1);
                    var params="header_uid="+val
                                +"&section_count="+section
                                +"&column_name="+col;
                    console.log(params);

						$.ajax({
							type: 'post'
							, url: 'http://localhost:3000/api/graph_calolimeter'
							, data: params
							, beforeSend: function() {
								$('#ajax_load_indicator').show().fadeIn('fast'); 
							}
							, success: function(data) {
                                console.log("일단 통신은 성공");
								if($("input:checkbox:checked").length >8){
                                    $('input[id='+col+']').prop('checked', false);
                                    alert("최대 8개까지 가능합니다.");
                                }
                                else{
                                    

                                }
							}
							, error: function(data, status, err) {
								console.log("error forward : "+data);
								alert('서버와의 통신이 실패했습니다.');
							}
							, complete: function() { 
								$('#ajax_load_indicator').fadeOut();
							}
						});
                }
                function graph_dxc(section,col){
                    console.log("enter login");
                    console.log($("input:checkbox[name=idubox]:checked").length);
                    var val = location.href.substr(
                    location.href.lastIndexOf('=') + 1);
                    var params="header_uid="+val
                                +"&section_count="+section
                                +"&column_name="+col;
                    console.log(params);

						$.ajax({
							type: 'post'
							, url: 'http://localhost:3000/api/graph_sidu_dxc'
							, data: params
							, beforeSend: function() {
								$('#ajax_load_indicator').show().fadeIn('fast'); 
							}
							, success: function(data) {
                                console.log("일단 통신은 성공");
								if($("input:checkbox:checked").length >8){
                                    $('input[id='+col+']').prop('checked', false);
                                    alert("최대 8개까지 가능합니다.");
                                }
                                else{

                                }
							}
							, error: function(data, status, err) {
								console.log("error forward : "+data);
								alert('서버와의 통신이 실패했습니다.');
							}
							, complete: function() { 
								$('#ajax_load_indicator').fadeOut();
							}
						});
                }
                function graph_awhp(section,col){
                    console.log("enter login");
                    console.log($("input:checkbox[name=idubox]:checked").length);
                    var val = location.href.substr(
                    location.href.lastIndexOf('=') + 1);
                    var params="header_uid="+val
                                +"&section_count="+section
                                +"&column_name="+col;
                    console.log(params);

						$.ajax({
							type: 'post'
							, url: 'http://localhost:3000/api/graph_sidu_awhp'
							, data: params
							, beforeSend: function() {
								$('#ajax_load_indicator').show().fadeIn('fast'); 
							}
							, success: function(data) {
                                console.log("일단 통신은 성공");
								if($("input:checkbox:checked").length >8){
                                    $('input[id='+col+']').prop('checked', false);
                                    alert("최대 8개까지 가능합니다.");
                                }
                                else{

                                }
							}
							, error: function(data, status, err) {
								console.log("error forward : "+data);
								alert('서버와의 통신이 실패했습니다.');
							}
							, complete: function() { 
								$('#ajax_load_indicator').fadeOut();
							}
						});
                }
                function graph_showcase(section,col){
                    console.log("enter login");
                    console.log($("input:checkbox[name=idubox]:checked").length);
                    var val = location.href.substr(
                    location.href.lastIndexOf('=') + 1);
                    var params="header_uid="+val
                                +"&section_count="+section
                                +"&column_name="+col;
                    console.log(params);

						$.ajax({
							type: 'post'
							, url: 'http://localhost:3000/api/graph_sidu_showcase'
							, data: params
							, beforeSend: function() {
								$('#ajax_load_indicator').show().fadeIn('fast'); 
							}
							, success: function(data) {
                                console.log("일단 통신은 성공");
								if($("input:checkbox:checked").length >8){
                                    $('input[id='+col+']').prop('checked', false);
                                    alert("최대 8개까지 가능합니다.");
                                }
                                else{

                                }
							}
							, error: function(data, status, err) {
								console.log("error forward : "+data);
								alert('서버와의 통신이 실패했습니다.');
							}
							, complete: function() { 
								$('#ajax_load_indicator').fadeOut();
							}
						});
                }
                function graph_fau(section,col){
                    console.log("enter login");
                    console.log($("input:checkbox[name=idubox]:checked").length);
                    var val = location.href.substr(
                    location.href.lastIndexOf('=') + 1);
                    var params="header_uid="+val
                                +"&section_count="+section
                                +"&column_name="+col;
                    console.log(params);

						$.ajax({
							type: 'post'
							, url: 'http://localhost:3000/api/graph_sidu_fau'
							, data: params
							, beforeSend: function() {
								$('#ajax_load_indicator').show().fadeIn('fast'); 
							}
							, success: function(data) {
                                console.log("일단 통신은 성공");
								if($("input:checkbox:checked").length >8){
                                    $('input[id='+col+']').prop('checked', false);
                                    alert("최대 8개까지 가능합니다.");
                                }
                                else{

                                }
							}
							, error: function(data, status, err) {
								console.log("error forward : "+data);
								alert('서버와의 통신이 실패했습니다.');
							}
							, complete: function() { 
								$('#ajax_load_indicator').fadeOut();
							}
						});
                }
                function graph_whu(section,col){
                    console.log("enter login");
                    console.log($("input:checkbox[name=idubox]:checked").length);
                    var val = location.href.substr(
                    location.href.lastIndexOf('=') + 1);
                    var params="header_uid="+val
                                +"&section_count="+section
                                +"&column_name="+col;
                    console.log(params);

						$.ajax({
							type: 'post'
							, url: 'http://localhost:3000/api/graph_sidu_whu'
							, data: params
							, beforeSend: function() {
								$('#ajax_load_indicator').show().fadeIn('fast'); 
							}
							, success: function(data) {
                                console.log("일단 통신은 성공");
								if($("input:checkbox:checked").length >8){
                                    $('input[id='+col+']').prop('checked', false);
                                    alert("최대 8개까지 가능합니다.");
                                }
                                else{

                                }
							}
							, error: function(data, status, err) {
								console.log("error forward : "+data);
								alert('서버와의 통신이 실패했습니다.');
							}
							, complete: function() { 
								$('#ajax_load_indicator').fadeOut();
							}
						});
                }
                function graph_cascade(section,col){
                    console.log("enter login");
                    console.log($("input:checkbox[name=idubox]:checked").length);
                    var val = location.href.substr(
                    location.href.lastIndexOf('=') + 1);
                    var params="header_uid="+val
                                +"&section_count="+section
                                +"&column_name="+col;
                    console.log(params);

						$.ajax({
							type: 'post'
							, url: 'http://localhost:3000/api/graph_sidu_cascade'
							, data: params
							, beforeSend: function() {
								$('#ajax_load_indicator').show().fadeIn('fast'); 
							}
							, success: function(data) {
                                console.log("일단 통신은 성공");
								if($("input:checkbox:checked").length >8){
                                    $('input[id='+col+']').prop('checked', false);
                                    alert("최대 8개까지 가능합니다.");
                                }
                                else{

                                }
							}
							, error: function(data, status, err) {
								console.log("error forward : "+data);
								alert('서버와의 통신이 실패했습니다.');
							}
							, complete: function() { 
								$('#ajax_load_indicator').fadeOut();
							}
						});
                }

                function drawingZZ(array,indexName,arraylength){
                    var chartDrowFun = {

                        chartDrow : function(){
                            var chartData = '';

                            //날짜형식 변경하고 싶으시면 이 부분 수정하세요.
                            var chartDateformat     = 'HH:mm:ss';
                            //라인차트의 라인 수
                            var chartLineCount    = 10;
                            //컨트롤러 바 차트의 라인 수
                            var controlLineCount    = 10;


                            function drawDashboard() {

                            var data = new google.visualization.DataTable();
                            var distinct=[];
                            //그래프에 표시할 컬럼 추가

                            data.addColumn('date',indexName[0]);
                            for(var i=1;i<indexName.length;i++){
                                data.addColumn('number',indexName[i]);
                                var split = indexName[i].split('_');
                                distinct.push(split[split.length-1]);
                           
                            }
                           
                            // data.addColumn('date' , '날짜');
                            // data.addColumn('number'   , '전체');

                            //그래프에 표시할 데이터
                            var dataRow = [];
                            var mindata;
                            
                            

                            for(var i = 0; i < arraylength; i++){ //데이터 삽입
                                // var total   = datazz[i].value;
                                // var datezz = datazz[i].TXT_TIME;
                                // console.log(datezz);
                                // dataRow = [new Date(datezz),total];
                                
                                data.addRow(array[i]);
                                mindata = Math.min(array[i]);
                            }


                                var chart = new google.visualization.ChartWrapper({
                                chartType   : 'LineChart',
                                containerId : 'lineChartArea', //라인 차트 생성할 영역
                                options     : {
                                               // chartArea : {right:136},
                                                isStacked   : 'percent',
                                                focusTarget : 'category',
                                                height          : 500,
                                                width              : '100%',
                                                legend          : { position: "top", textStyle: {fontSize: 13}},
                                                pointSize        : 5,
                                                tooltip          : {textStyle : {fontSize:12}, showColorCode : true,trigger: 'both'},
                                                hAxis              : {format: chartDateformat, gridlines:{count:chartLineCount,units: {
                                                                                    hours : {format: ['HH시']},
                                                                                    minutes: {format: ['mm분']},
                                                                                    seconds  : {format: ['ss초']},
                                                                                        }
                                                                                    },textStyle: {fontSize:12}},
                                    
                                    series:{
                                        0:{targetAxisIndex:0},
                                        1:{targetAxisIndex:1},
                                        2:{targetAxisIndex:2},
                                            },
                                    vAxes              : {0:{minValue: 10,viewWindow:{min:mindata},gridlines:{count:-1},textStyle:{fontSize:12}},
                                                          1:{label: '˚C',minValue: 10,viewWindow:{min:mindata},gridlines:{count:-1},textStyle:{fontSize:12},side:'left'},
                                                          2:{title: 'kPa',minValue: 10,viewWindow:{min:mindata},gridlines:{count:-1},textStyle:{fontSize:12},position:'left'},
                                                          },
                                    animation        : {startup: true,duration: 1000,easing: 'in' },
                                    annotations    : {pattern: chartDateformat,
                                                    textStyle: {
                                                    fontSize: 15,
                                                    bold: true,
                                                    italic: true,
                                                    color: '#871b47',
                                                    auraColor: '#d799ae',
                                                    opacity: 0.8,
                                                    pattern: chartDateformat
                                                }
                                                },

                                }
                                });

                                var control = new google.visualization.ControlWrapper({
                                controlType: 'ChartRangeFilter',
                                containerId: 'controlsArea',  //control bar를 생성할 영역
                                options: {
                                    ui:{
                                            chartType: 'LineChart',
                                            chartOptions: {
                                            chartArea: {'width': '60%','height' : 80},
                                            hAxis: {'baselineColor': 'none', format: chartDateformat, textStyle: {fontSize:12},
                                                gridlines:{count:controlLineCount,units: {
                                                    hours: {format: ['HH시']},
                                                    minutes: {format: ['mm분']},
                                                    seconds  : {format: ['ss초']},
                                                    }
                                                }}
                                            }
                                    },
                                        filterColumnIndex: 0
                                    }
                                });

                                var date_formatter = new google.visualization.DateFormat({ pattern: chartDateformat});
                                date_formatter.format(data, 0);

                                var dashboard = new google.visualization.Dashboard(document.getElementById('Line_Controls_Chart'));
                                window.addEventListener('resize', function() { dashboard.draw(data); }, false); //화면 크기에 따라 그래프 크기 변경
                                dashboard.bind([control], [chart]);
                                dashboard.draw(data);

                            }
                            google.charts.setOnLoadCallback(drawDashboard);

                        }
                        }

                        // $(document).ready(function(){
                        google.charts.load('current', {'packages':['line','controls']});
                        chartDrowFun.chartDrow(); //chartDrow() 실행
                        //  });

                }
                        

    </script>
</html>