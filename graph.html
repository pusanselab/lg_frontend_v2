<!DOCTYPE html>
<html>
    <header>
        <title>LG Air Data Virtualization</title>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
       
        <link rel="stylesheet" href="css/bootstrap.css">
    </header>
    <body>
        <div id="sub">
            <h1> ■ 그래프 추가</h1>


        </div>
        <div id="graph_table" class="table-responsive">
                <table id="detail_table" class="table table-striped table-bordered table-hover table-condensed">
                <tbody id="detail_body">
                    <thead>
                    <tr>
                    <td>name</td>
                    <td>unit</td>
                    <td>section</td>
                    <td>sector</td>
                    <td>그래프 선택</td>
                </thead>
                </tr>
            </tbody>
            </table>

            <button class='button' onclick='showGraph()'>그래프 보기</button>

        </div>
        <div id="graph">
            <div id="Line_Controls_Chart">
                <!-- 라인 차트 생성할 영역 -->
                    <div id="lineChartArea" style="padding:0px 20px 0px 0px;"></div>
                <!-- 컨트롤바를 생성할 영역 -->
                    <div id="controlsArea" style="padding:0px 20px 0px 0px;"></div>
              </div>
            <div id="selectgraph1">
                <form id="selectgraph">

                </form>
            </div>
        </div>
        <span></span>
    </body>



    <!--Script-->

    <script src="assets/js/jquery.min.js"></script>
    <script src="assets/js/jquery.scrolly.min.js"></script>
    <script src="assets/js/jquery.dropotron.min.js"></script>
    <script src="assets/js/jquery.scrollex.min.js"></script>
    <script src="assets/js/browser.min.js"></script>
    <script src="assets/js/breakpoints.min.js"></script>
    <script src="assets/js/util.js"></script>
    <script src="assets/js/main.js"></script>
    <script src="http://code.jquery.com/ui/1.11.2/jquery-ui.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script> 
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script src="https://d3js.org/d3-array.v2.min.js"></script>
    <script src="https://d3js.org/d3-color.v1.min.js"></script>
    <script src="https://d3js.org/d3-format.v1.min.js"></script>
    <script src="https://d3js.org/d3-interpolate.v1.min.js"></script>
    <script src="https://d3js.org/d3-time.v1.min.js"></script>
    <script src="https://d3js.org/d3-time-format.v2.min.js"></script>
    <script src="https://d3js.org/d3-scale.v3.min.js"></script>
    <script data-require="d3@4.0.0" data-semver="4.0.0" src="https://d3js.org/d3.v4.min.js"></script>

    <link href="http://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css" rel="stylesheet">   
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
    <link rel="stylesheet" href="http://cdn.datatables.net/1.10.2/css/jquery.dataTables.min.css"></style>
    <script type="text/javascript" src="http://cdn.datatables.net/1.10.2/js/jquery.dataTables.min.js"></script>
    <script type="text/javascript" src="http://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>
    
    <script>


            var array;
            var index=0;
            var indexName=['Date'];
            var colName=[];
            var rowcount;
            var val;
                

            $(document).ready(function(){
                val = location.href.substr(
                location.href.lastIndexOf('=') + 1);
				console.log("enter login");
                var params="header_uid="+val;
				$.ajax({
					type: 'post'
					, url: 'http://localhost:3000/api/graph/items'
					, data: params
					, beforeSend: function() {
						$('#ajax_load_indicator').show().fadeIn('fast'); 
					}
					, success: function(data) {

                        for(var i=0;i<data.length;i++){
                            var header_uid = data[i].header_uid;
                            var name = data[i].name;
                            var unit = data[i].unit;
                            var section = data[i].section;
                            var section_count = data[i].section_count;
                            var check = "<p id=\'checking_"+data[i].item+"\' style='display:none'>"+i+"</p>"+"<input type='checkbox' name=\'check'\ id=\""+data[i].item+"\" onclick=\"select_box(\'"+data[i].item+"\',\'"+name+"\')\" value=''/>";

                            var row = "<tr>";
                                  //  row+="<td>"+header_uid+"</td>";
                                    row+="<td>"+name+"</td>";
                                    row+="<td>"+unit+"</td>";
                                    row+="<td>"+section+"</td>";
                                    row+="<td>"+section_count+"</td>";
                                    row+="<td>"+check+"</td>";
                                    row+="</tr>"

                                $('#detail_body').append(row);
                        }
                        $('#detail_table').dataTable();
							
						}
						, error: function(data, status, err) {
							console.log("error forward : "+data);
							alert('서버와의 통신이 실패했습니다.');
						}
						, complete: function() { 
							$('#ajax_load_indicator').fadeOut();
						}
					});
				});

           
       
                function showGraph(){
                   var rowData = new Array();
                    var jsonparams = JSON.stringify({'header_uid':val,'item_list':colName});
                    console.log(jsonparams);

                console.log("enter login");
                $.ajax({
                    type: 'post'
                    , url: 'http://localhost:3000/api/graph/raws'
                    , data: jsonparams
                    , dataType:'json'
                    , contentType:'application/json'
                    , beforeSend: function() {
                        $('#ajax_load_indicator').show().fadeIn('fast'); 
                    }
                    , success: function(data) {
                        rowcount = data.time.length;

                        array=new Array(rowcount+1);
                        for(var i =0 ;i<rowcount+1;i++){
                            array[i]=new Array();
                        }

                        if($("input:checkbox:checked").length >0){
                            console.log("이안");
        
                            var datazz = data.time;
                            var dataxx = data.raws;
                            var min_max_check;
                            min_max_check=new Array();
                            for(var i =0 ;i<indexName.length;i++){
                                min_max_check[i]=new Array();
                            }
                            console.log(dataxx[1]);
                            var real_value = $.extend(true,[],dataxx[1]);

                           
                            
                            

                                for(var i =0; i<datazz.length;i++){
                                            var index = 1;
                                            var timedate = datazz[i].Date+" "+datazz[i].time;
                                            array[i][0]=((new Date(timedate)));
                                            $.each(dataxx[i],function(key,value){
                                                    array[i][index]=value*1;
                                                    min_max_check[index-1][i]=(value*1);
            
                                                    index=index+1;
                                                });
                                            }
                                    }
                                    
                                    // for(var i=0;i<indexName.length;i++){
                                    //     console.log(min_max_check[i]);
                                    // }
                                    drawingZZ(array,indexName,datazz.length,min_max_check);
                            
                    }
                    , error: function(data, status, err) {
                        console.log("error forward : "+data);
                        alert('서버와의 통신이 실패했습니다.');
                    }
                    , complete: function() { 
                        $('#ajax_load_indicator').fadeOut();
                    }
                 });


                }


                function select_box(col,name){
                          
                    if($("input:checkbox:checked").length >8){
                        $('input[id='+col+']').prop('checked', false);
                        $("#checking_"+col).html('not_checked');
                        
                        alert("최대 8개까지 가능합니다.");
                    }
                    else{
                        $("#checking_"+col).html('checked');
                        if(!($('input[id='+col+']').is(':checked'))){
                            var remove=indexName.indexOf(name);
                            var remove2=colName.indexOf(col);
                            $("#checking_"+col).html('not_checked');
                            
                    
                            indexName.splice(remove,1);
                            colName.splice(remove2,1);
                            index-=1;
                            
                        }
                        else{

                        index+=1;     
                                                    
                        indexName.push(name);
                        colName.push(col);

                        }
                    }
                }

        
              

                function drawingZZ(array,indexName,arraylength,min_max_check){
                    var chartDrowFun = {

                        chartDrow : function(){
                            var chartData = '';

                            //날짜형식 변경하고 싶으시면 이 부분 수정하세요.
                            var chartDateformat     = 'HH:mm:ss';
                            //라인차트의 라인 수
                            var chartLineCount    = 10;
                            //컨트롤러 바 차트의 라인 수
                            var controlLineCount    = 10;


                            function drawDashboard() {

                            var data = new google.visualization.DataTable();
                            var distinct=[];
                            //그래프에 표시할 컬럼 추가

                            data.addColumn('datetime',indexName[0]);
                            for(var i=1;i<indexName.length;i++){
                                data.addColumn('number',indexName[i]);
                                var split = indexName[i].split('_');
                                distinct.push(split[split.length-1]);
                           
                            }
                           
                            // data.addColumn('date' , '날짜');
                            // data.addColumn('number'   , '전체');

                            //그래프에 표시할 데이터
                            var dataRow = [];
                            var mindata=[];
                            var maxdata=[];
                            console.log(min_max_check[0]);
                            
                            

                            for(var i = 0; i < arraylength; i++){ //데이터 삽입
                                // var total   = datazz[i].value;
                                // var datezz = datazz[i].TXT_TIME;
                                // console.log(datezz);
                                // dataRow = [new Date(datezz),total];
                                
                                data.addRow(array[i]);
                                
                            }
                            for(var i=0;i<indexName.length-1;i++){
                                var minzz_ = Math.min.apply(null,min_max_check[i]);
                                var maxzz_ = Math.max.apply(null,min_max_check[i]);

                               
                                mindata.push(minzz_);
                                maxdata.push(maxzz_);
                                console.log("점프점프");
                                console.log(mindata[i]);
                                console.log(maxdata[i]);
                            }



                                var chart = new google.visualization.ChartWrapper({
                                chartType   : 'LineChart',
                                containerId : 'lineChartArea', //라인 차트 생성할 영역
                                options     : {
                                               // chartArea : {right:136},
                                                isStacked   : 'percent',
                                                focusTarget : 'category',
                                                height          : 500,
                                                width              : '100%',
                                                legend          : { position: "top", textStyle: {fontSize: 13}},
                                                pointSize        : 5,
                                                tooltip          : {textStyle : {fontSize:12}, showColorCode : true,trigger: 'both'},
                                                hAxis              : {format: chartDateformat, gridlines:{count:chartLineCount,units: {
                                                                                    hours : {format: ['HH시']},
                                                                                    minutes: {format: ['mm분']},
                                                                                    seconds  : {format: ['ss초']},
                                                                                        }
                                                                                    },textStyle: {fontSize:12}},
                                    
                                    series:{
                                        0:{targetAxisIndex:0}, 
                                        1:{targetAxisIndex:1},
                                        2:{targetAxisIndex:2},
                                        3:{targetAxisIndex:3}, 
                                        4:{targetAxisIndex:4},
                                        5:{targetAxisIndex:5},
                                        6:{targetAxisIndex:6}, 
                                        7:{targetAxisIndex:7}
                                            },
                                    vAxes              : {

                                                          0:{textPosition:'none',minValue: mindata[0],maxValue:maxdata[0],viewport:{min:mindata[0]},gridlines:{count:-1},textStyle:{fontSize:12}},
                                                          1:{textPosition:'none',minValue: mindata[1],maxValue:maxdata[1],viewWindow:{min:mindata[1]},gridlines:{count:-1},textStyle:{fontSize:12}},
                                                          2:{textPosition:'none',minValue: mindata[2],maxValue:maxdata[2],viewWindow:{min:mindata[2]},gridlines:{count:-1},textStyle:{fontSize:12}},
                                                          3:{textPosition:'none',minValue: mindata[3],maxValue:maxdata[3],viewWindow:{min:mindata[3]},gridlines:{count:-1},textStyle:{fontSize:12}},
                                                          4:{textPosition:'none',minValue: mindata[4],maxValue:maxdata[4],viewWindow:{min:mindata[4]},gridlines:{count:-1},textStyle:{fontSize:12}},
                                                          5:{textPosition:'none',minValue: mindata[5],maxValue:maxdata[5],viewWindow:{min:mindata[5]},gridlines:{count:-1},textStyle:{fontSize:12}},
                                                          6:{textPosition:'none',minValue: mindata[6],maxValue:maxdata[6],viewWindow:{min:mindata[6]},gridlines:{count:-1},textStyle:{fontSize:12}},
                                                          7:{textPosition:'none',minValue: mindata[7],maxValue:maxdata[7],viewWindow:{min:mindata[7]},gridlines:{count:-1},textStyle:{fontSize:12}},
                                                          
                                                          
                                                          },
                                    animation        : {startup: true,duration: 1000,easing: 'in' },
                                    annotations    : {pattern: chartDateformat,
                                                    textStyle: {
                                                    fontSize: 15,
                                                    bold: true,
                                                    italic: true,
                                                    color: '#871b47',
                                                    auraColor: '#d799ae',
                                                    opacity: 0.8,
                                                    pattern: chartDateformat
                                                }
                                                },

                                }
                                });

                                var control = new google.visualization.ControlWrapper({
                                controlType: 'ChartRangeFilter',
                                containerId: 'controlsArea',  //control bar를 생성할 영역
                                options: {
                                    ui:{
                                            chartType: 'LineChart',
                                            chartOptions: {
                                            chartArea: {'width': '60%','height' : 80},
                                            hAxis: {'baselineColor': 'none', format: chartDateformat, textStyle: {fontSize:12},
                                                gridlines:{count:controlLineCount,units: {
                                                    hours: {format: ['HH시']},
                                                    minutes: {format: ['mm분']},
                                                    seconds  : {format: ['ss초']},
                                                    }
                                                }}
                                            }
                                    },
                                        filterColumnIndex: 0
                                    }
                                });

                                var date_formatter = new google.visualization.DateFormat({ pattern: chartDateformat});
                                date_formatter.format(data, 0);

                                var dashboard = new google.visualization.Dashboard(document.getElementById('Line_Controls_Chart'));
                                window.addEventListener('resize', function() { dashboard.draw(data); }, false); //화면 크기에 따라 그래프 크기 변경
                                dashboard.bind([control], [chart]);
                                dashboard.draw(data);

                               }
                            google.charts.setOnLoadCallback(drawDashboard);

                            }
                        }

                        // $(document).ready(function(){
                        google.charts.load('current', {'packages':['line','controls']});
                        chartDrowFun.chartDrow(); //chartDrow() 실행
                        //  });

                       

                        

           

                        $('#graph').append('<button onClick="downloadCSV(array,indexName);">CSV 다운로드</button>');



                }

                function downloadCSV(array,indexName){
                    
                    var csv_string='';
                    for(var i=0;i<indexName.length;i++){
                        if(i<indexName.length-1){
                                csv_string+=indexName[i]+",";
                            }
                            else{
                                csv_string+=indexName[i]+"\r\n";
                            }
                    }
                    for(var i =0; i<array.length;i++){
                        for (var j=0;j<array[i].length;j++){
                            if(j<array[i].length-1){
                                csv_string+=array[i][j]+",";
                            }
                            else{
                                csv_string+=array[i][j]+"\r\n";
                            }
                        }
                    }
                
                    var downloadLink = document.createElement("a");
                    var blob = new Blob(["\ufeff"+csv_string], { type: "text/csv;charset=utf-8" });
                    var url = URL.createObjectURL(blob);
                    downloadLink.href = url;
                    downloadLink.download = "data.csv";

                    document.body.appendChild(downloadLink);
                    downloadLink.click();
                    document.body.removeChild(downloadLink);
                }
                

    </script>
</html>